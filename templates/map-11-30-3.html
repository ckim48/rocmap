{% extends "core.html" %}
{% block title %}Rocmap{% endblock %}
{% block body %}
<style>
    html, body {
        font-family: Arial, sans-serif;
        height: 100%;
        margin: 0;
        padding: 0;
    }

    #map {
        width: 100%;
        height: calc(100% - 54px);

    }

    #log-container {
        position: absolute;
        top: 10px;
        left: 80%;
        z-index: 5;
        height: 10%;
        padding: 5px;
        text-align: center;
    }

    #search-panel {
        position: absolute;
        top: 40px;
        left: 65%;
        z-index: 5;
        height: 50%;
        background-color: #fff;
        padding: 5px;
        text-align: center;
    }

    #pano {
        width: 200px;
        height: 200px;
    }

    .class-word {
        text-align: center;
    }

    .vertical-alignment-helper {
        display: table;
        height: 100%;
        width: 100%;
        pointer-events: none; /* This makes sure that we can still click outside of the modal to close it */
    }

    .vertical-align-center {
        /* To center vertically */
        display: table-cell;
        vertical-align: middle;
        pointer-events: none;
    }

    .modal-content {
        /* Bootstrap sets the size of the modal in the modal-dialog class, we need to inherit it */
        width: inherit;
        max-width: inherit; /* For Bootstrap 4 - to avoid the modal window stretching full width */
        height: inherit;
        /* To center horizontally */
        margin: 0 auto;
        pointer-events: all;
        position: relative;
        overflow: hidden;
        height: 450px;
    }

    select:disabled {
        cursor: not-allowed;
        pointer-events: all !important;
    }

/*Change on 11/28 by JING SUN*/
	.modal-dialog {
		max-width: 800px;
		height: 75%;
	}
	#loginForm {
		width: 50%;
		margin-top: -22px !important;
		margin-left: 52px !important;
		float: left;
		display: inline-block;
		border: 1px solid #F0F0F0;
		padding: 10px;
		box-shadow: 20px 20px 15px #ddd;
	}
	#registerForm {
		width: 50%;
		margin-top: 10px !important;
		margin-left: 24px !important;
		float: left;
		display: inline-block;
		border: 1px solid #F0F0F0;
		padding: 10px;
		box-shadow: 20px 20px 15px #ddd;
	}
	#log_bdg_1 {
		margin-right: -347px;
		height: 486px;
		float: right;
		display: inline-block;
		border-left: 1px solid #F0F0F0;
		margin-top: -31px;
	}
	#log_bdg_2 {
		margin-right: -362px;
		height: 486px;
		float: right;
		display: inline-block;
		border-left: 1px solid #F0F0F0;
		margin-top: 60px;
	}
	#roc_map_title {
		font-family: wormbox, Arial, sans-serif;
		font-weight:bold;
		font-size: 40px;
		margin-left: 132px;
		margin-top: 15px;
	}
	@font-face {
	font-family: "wormbox";
	src: url("../static/font/wormbox_rounded.eot");
	src: local("wormbox_rounded"),
	local("wormbox_rounded"),
	url("../static/font/wormbox_rounded.woff") format("woff"),
	url("../static/font/wormbox_rounded.ttf") format("truetype"),
	url("../static/font/wormbox_rounded.svg") format("svg");
	}
/*END OF Change on 11/28 by JING SUN*/

/* Building name autocomplete by JING SUN 2017.11.18 */
    .ui-autocomplete.ui-widget {
        font-family: Verdana, Arial, sans-serif;
        font-size: 12px;
	max-height: 300px;
	height: auto;
	overflow-y: auto;
	overflow-x: hidden;
	width: 50px;
	word-wrap: break-word;
    }
    .ui-state-hover, .ui-state-hover {
	background-color: green !important;
	border: none !important;
	background: none !important;
    }
/* END OF Building name autocomplete by JING SUN 2017.11.18 */

/* Building information by JING SUN 2017.11.18 */
    #hidden_info {
        /*TEST 2*/
        display: none;
        position: fixed;
        top: 20%;
        left: 23%;
        width: 50%;
        z-index: 999;
        /*END OF TEST 2*/
    }

    .card-header {
        color: white;
        font-size: 18px;
        font-weight: bold;
    }

    .card-block {
        padding: 10px;
        font-size: 14px;
        color: white;
    }

    .table {
    	font-size: 14px;
    }
/* END OF Building information by JING SUN 2017.11.18 */
/* Chat related css 2017.11.27 */

    #chatModal {
      min-width: 400px;
      height: 70vh;
      overflow-y: hidden;
      display: none;
    }

    .chat-dialog {
      width: 100%;
      height: inherit;
    }

    .chat-dialog .modal-content {
      height: inherit;
      overflow-y: initial !important
    }

    .chat-dialog .modal-content .modal-body {
      overflow-y: auto;
    }

    .btn-circle.btn-lg {
      width: 50px;
      height: 50px;
      padding: 12px 10px;
      font-size: 18px;
      line-height: 1.2;
      border-radius: 25px;
    }

    .chatBtn {
      position: fixed;
      bottom: 48px;
      left: 48px;
      z-index: 1;
    }
    .fill-auto {
        display: flex;
        width: 100%;
    }

    .fill-left {
        width: 100% !important;
    }

    .fill-right {
        width: 80px;
    }

    .flex-grow {
        flex: 1;
    }

    .chat-profile {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 5px solid rgba(255, 255, 255, 0.5);
    }
    #loadMoreBtn {
        width: 100%
    }

    .chat-item {
        border: none;
    }
    .chat-profile {
        display: inline-block;
    }
    .chat-div {
        display: inline-block;
        vertical-align: middle;
    }

    .btn-circle.btn-lg {
      width: 50px;
      height: 50px;
      padding: 12px 10px;
      font-size: 18px;
      line-height: 1.2;
      border-radius: 25px;
    }

    .toTopBtn {
      position: fixed;
      bottom: 48px;
      right: 16px;
    }

	#chat-close {
	  position: fixed;
	  top: 24px;
	  right: 24px;
	  z-index: 1;
	  font-size: 28px;
	}
	
    #chat-content {
      margin-bottom: 18px;
      padding-bottom: 12px;
    }

    .labels{
      font-family: 'Gloria Hallelujah', cursive;
      font-size: 90%;
      color: green;
    }
	.modal {
	  top: auto;
	  right: auto;
	}

      #floating-panel {
        position: absolute;
        top: 10px;
        float: left
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
/* END OF  Chat related css 2017.11.27 */

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<nav class="navbar navbar-dark bg-dark">


    <!-- add logout button here -->
    <div>
        {% if isLogined %}
        <form action="{{ url_for('profile') }}" style="display: inline-block;">
            <button class="btn btn-success" type="submit">Profile</button>
        </form>
        <form action="{{ url_for('logout') }}" style="display: inline-block;">
            <button class="btn btn-primary" type="submit">Logout</button>
        </form>
            <button onclick="clearMarkers();"  class="btn btn-primary">Hide all Locations"</button>
	    <button onclick="showMarkers();"  class="btn btn-primary">Show all Locations"</button>
	    <button onclick="deleteMarkers();"  class="btn btn-primary">Delete all Markers"</button>



        {% else %}
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#loginModal">Login</button>
            <button onclick="clearMarkers();"  class="btn btn-primary">Hide all Locations"</button>
            <button onclick="showMarkers();"  class="btn btn-primary">Show all Locations"</button>
            <button onclick="deleteMarkers();"  class="btn btn-primary">Delete all Markers"</button>


        <!-- Login Modal by Seungho 2017.11.12 -->
        <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
             aria-hidden="true">
            <div class="vertical-alignment-helper">
                <div class="modal-dialog vertical-align-center" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>

                            <div class="alert-top">
                            </div>

                            <p id="roc_map_title">ROC MAP</p>

                            <form id="loginForm" name="loginForm" style="margin: 18px;">
                                <div class="form-group">
                                    <label for="Email1">Email address</label>
                                    <input type="email" class="form-control" id="Email1" name="usr_email"
                                           aria-describedby="emailHelp" placeholder="Enter email" required>
                                    <small id="emailHelp" class="form-text text-muted">We"ll never share your email with
                                        anyone else.
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label for="Password">Password</label>
                                    <input type="password" class="form-control" id="Password" name="usr_password"
                                           placeholder="Password" required>
                                </div>
                                <div class="text-right">
                                    <div class="form-check">
                                        <label class="form-check-label">
                                            <input type="checkbox" id="stayloggedin" name="chk_box"
                                                   class="form-check-input"
                                                   value="unchecked"> Stay Logged In</label>
                                    </div>
                                    <p><a href="" data-toggle="modal" data-target="#registerModal" data-dismiss="modal">Not
                                        a member yet?</a></p>


                                    <fieldset class="form-group">
                                        <input class="btn btn-success" type="submit" id="auth" name="submit"
                                               value="Log in!">
                                    </fieldset>

                                </div>
                            </form>

                            <img src="../static/images/bdg.png" id="log_bdg_1">
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Register Modal by Seungho 2017.11.15 -->
        <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="registerModalLabel"
             aria-hidden="true">
            <div class="vertical-alignment-helper">
                <div class="modal-dialog vertical-align-center" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>

                            <div class="alert-top">
                            </div>
                            <form id="registerForm" name="registerForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="usr">E-mail</label>
                                        <input type="text" class="form-control" id="usr" placeholder="E-mail"
                                               name="email" required></div>
                                    <div class="col-md-6 mb-3">
                                        <label for="pwd">Password</label>
                                        <input type="password" class="form-control" id="pwd" placeholder="Password"
                                               name="password" required></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="nm">Name</label>
                                        <input type="text" class="form-control" id="nm" placeholder="Name" name="name"
                                               required></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="school-select">School</label>
                                        <select class="form-control" id="school-select" placholder="School"
                                                name="school" required>
                                            <option value="">Select School</option>
                                            <option value="artsandscience">School of Arts and Sciences</option>
                                            <option value="engineering">Hajim School of Engineering and Applied
                                                Sciences
                                            </option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="sub">Major</label>
                                        <select id="major" class="form-control" id="sub" name="major" required disabled>
                                            <option value="">Please select your school</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="buttonHolder">
                                    <button class="btn btn-primary" type="submit">Sign up</button>
                                </div>
                            </form>

                            <img src="../static/images/bdg.png" id="log_bdg_2">
                        </div>
                    </div>
                </div>


            </div>
        </div>
        {% endif %}
    </div>
 <!--   <form id="building-search" class="form-inline">
        <input id="address" class="form-control mr-sm-2" type="textbox" value="Rushrhees Library">
        <input id="submit" class="btn btn-outline-success my-2 my-sm-0" type="button" value="Search">
    </form>-->
<!-- test by Shaoyi Huang-->
<form id="building-search" class="search_bar">
  <div class="search_dropdown" style="width: 16px;">
    <span>All</span>
    <ul>
      <li class="selected">All</li>
      <li>Building</li>
      <li>Course</li>
    </ul>
  </div>

  <input id="address" type="text" placeholder="Rush Rhees Library" />

  <button id="submit" type="submit" value="Search">Search</button>
</form>

</nav>

{% if isLogined %}
<!-- Chat related Seungho Baik 2017.11.27 -->

<button type="button" class="chatBtn btn btn-danger btn-circle btn-lg" data-toggle="modal" data-target="#chatModal"><i class="material-icons">chat</i></button>

<div class="modal" id="chatModal" tabindex="-1" role="dialog" aria-labelledby="chatModalLabel" aria-hidden="true" data-keyboard="true" data-backdrop="false">
  <div class="chat-dialog modal-dialog chat-body" role="document">
    <div class="modal-content">
      <div id="scroll-chat-body" class="modal-body">
        <button id="chat-close" type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <div id="chat-content">
          <button type="button" class="btn btn-outline-dark" id="loadMoreBtn">Load More</button>
          <div class="flex-grow">
            <ul class="list-group">
              {% for chat in msg %}
              <li class="list-group-item chat-item">
                <img src='{{ chat.photo }}' class="chat-profile rounded">
                <div class="chat-div">
                  <div>{{ chat.time }}</div>
                  <div>{{ chat.name }}</div>
                  <div>{{ chat.content }}</div>
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>

          <form id="chat-form" class="form-inline">
            <div class="fill-auto">
              <input id="chatspace" class="form-control fill-left" type="text" placeholder="Type your chat here">
              <button id="sendchat" type="submit" class="btn btn-primary fill-right">Send</button>
            </div>
          </form>
        </div>
        <button type="button" class="toTopBtn btn btn-info btn-circle btn-lg"><i class="material-icons">keyboard_arrow_up</i></button>


        <script>
        $(document).ready(function () {
          $('#chatModal').hide();
          $('#chatModal').on('shown.bs.modal', function (e) {
            var objDiv = document.getElementById("chat-content");
            document.getElementById('scroll-chat-body').scrollTop = objDiv.scrollHeight;
			return e;
          });



          $('.toTopBtn').hide();
          var loadedCount = {{ chatSize }};
          // $('#chatModal').scrollTo(0, document.getElementById('chatModal').scrollHeight);


          var socket = io.connect('https://' + document.domain + ':' + location.port + '/chatroom');
          socket.on('message', function (msg) {
            $('.list-group').append('<li class="list-group-item chat-item"><img src="' + msg.photo + '" class="chat-profile rounded"><div class="chat-div"><div>' + msg.time + "</div><div>" + msg.name + '</div><div>' + msg.content + '</div></div></li>');

              var objDiv = document.getElementById("chat-content");
              document.getElementById('scroll-chat-body').scrollTop = objDiv.scrollHeight;
          });
          $('#chat-form').submit(function (event) {
            event.preventDefault();
            socket.emit('text', {msgContent: $('#chatspace').val()});
            $('#chatspace').val("");
            return false;
          });

          $('sendchat').click(function (event) {
            event.preventDefault();
            socket.emit('text', {msgContent: $('#chatspace').val()});
            $('#chatspace').val("");
            return false;
          });

          var btnVisible = false;
          $('#scroll-chat-body').scroll(function () {

            if ($(window).scrollTop() == 0) {
              //                showAlert('top', true);
              //Add load more functions using loadCount and Ajax
            }

            if($('#scroll-chat-body').scrollTop() +  $('#scroll-chat-body').height() > $('#chat-content').height()  - 100) {
              if (btnVisible == true){
                $('.toTopBtn').hide();
                btnVisible = false;
              }
            } else {
              if (btnVisible == false){
                $('.toTopBtn').show();
                // $('.chat-content').scrollTop($('.chat-content').prop("scrollHeight"));
                btnVisible = true;
              }
            }
          });

          $('.toTopBtn').click(function(){
            $('#scroll-chat-body').animate({scrollTop: '0px'}, 300);
          });

          $('#loadMoreBtn').click(function (event) {
            event.preventDefault();
            $.ajax({
              url: '/getChatAJAX',
              data: {"loadedMsgCount": loadedCount},
              type: 'POST',
              success: function (response) {
                var result = JSON.parse(response);
                console.log(result);

                for (var i = 0; i < result.length; i++) {
                  msg = result[i];
                  loadedCount++;
                  $('.list-group').prepend('<li class="list-group-item chat-item"><img src="' + msg.photo + '" class="chat-profile rounded"><div class="chat-div"><div>' + msg.time + "</div><div>" + msg.name + '</div><div>' + msg.content + '</div></div></li>');
                }
                if (result.length > 0) {
                  showAlert('Loaded more messages', true);
                } else {
                  showAlert('There are no more messages', false);
                }

              }
              ,
              error: function (error) {
                console.log(error);
                showAlert('Failed to load more messages', false);
                //                showAlert("There seems to be something wrong wit the server. Try again later!", false);
              }
            });
          });
        })



        </script>
      </div>
    </div>
  </div>


      </div>
  </div>
  {% endif %}
<!-- End of chat -->
<div id="map"></div>

<!-- Building information by JING SUN 2017.11.18 -->
<div class="card" id="hidden_info">
    <input type="button" id="close" value="X" class="btn btn-primary float-right border-0"></input>
    <div class="card-header text-center bg-primary"><span id="bdg"></span> BUILDING</div>
    <div class="card-block bg-secondary">COURSE INFORMATION</div>
    <table class="table table-hover">
	<thead>
	    <tr>
    		<th>Number</th>
    		<th>Name</th>
    		<th>Instructor</th>
	    </tr>
	<thead>
	<tbody id="crs"></tbody>
</div>
<!-- END OF Building information by JING SUN 2017.11.18 -->

<!-- Building Name autocomplete by JING SUN 2017.11.18-->
<script type="text/javascript">
    $(document).ready(function(){
        var a_Tags = [
                'Bausch & Lomb Hall(B&L)',
        	'Morey Hall(MOREY)',
        	'ET',
        	'Strong Auditorium(STRNG)',
        	'Hylan Building(HYLAN)',
        	'Dewey Hall(DEWEY)',
        	'The Margaret Warner Graduate School of Education and Human Development(LCHAS)',
        	'Meliora Hall(MEL)',
        	'Gavett Hall(GAVET)',
        	'Goergen Hall(GEH)',
        	'Rush Rhees Library(RRLIB)',
        	'Lattimore Hall(LATT)',
        	'Harkness Hall(HARK)',
        	'Frederick Douglass Building(DOUG)',
        	'Hoyt Hall(HOYT)',
        	'Hutchison Hall(HUTCH)',
        	'GEN',
        	'Carlson Library(CARLS)',
        	'Todd Union Building(TODD)',
        	'Goergen Athletic Center(GRGEN)',
        	'Friel Lounge(FRIEL)',
        	'SLATE',
        	'Computer Studies Building(CSB)',
        	'Wegmans Hall(WEGMN)',
        	'University Health Service(UHS)',
        	'Mount Hope Family Center(MHFC)',
        	'Spurrier Hall(SPURR)',
        	'OBRN',
        	'Sage Art Center(SAGE)',
        	'Rettner Hall(RETT)',
        	'Wilmot Building(WILMT)',
        	'Eastman School of Music(ESM)',
        	'Interfaith Chaple(CHAPL)',
        	'Hopeman Building(HOPE)',
        	'School of Medicine and Dentistry(MED)',
        	'SAUND',
        	'Gleason Hall(GLSON)',
            	'Susan B. Anthony Hall',
            	'Wilson Commons',
       		'Schlegel Hall',
            	'Gavett Hall',
            	'Institute of Optics'
	];
        $('#address').autocomplete({
            source: a_Tags
        });
    });
</script>
<!-- END OF Building Name autocomplete by JING SUN 2017.11.18-->

<!-- Login/Register Ajax Seungho 2017.11.12/2017.11.15 -->
<script>

    $('#loginForm').submit(function (event) {
        event.preventDefault();
        $.ajax({
            url: '/authenticateAJAX',
            data: $('#loginForm').serialize(),
            type: 'POST',
            success: function (response) {
                console.log(response);
                var result = JSON.parse(response);
                if (result["authOK"] === "OK") {
                    console.log("OK");
                    showAlert(result["message"], true);

                    if (result["expires"].length == 0) {
                        Cookies.set('session_key', result["cookie"]);
                    } else {
                        Cookies.set('session_key', result["cookie"], {expires: parseInt(result["expires"])});
                    }
                    window.location.reload();
                } else if (result["authOK"] === "NO") {
                    console.log("ERROR");
                    showAlert(result["message"], false);
                }
            },
            error: function (error) {
                console.log(error);
                showAlert("There seems to be something wrong wit the server. Try again later!", false);
            }
        });
    });

    $('#registerForm').submit(function (event) {
        event.preventDefault();
        $.ajax({
            url: '/registerAJAX',
            data: $('#registerForm').serialize(),
            type: 'POST',
            success: function (response) {
                console.log(response);
                var result = JSON.parse(response);
                console.log(result);
                if (result["regOK"] === "OK") {
                    console.log("regOK");
                    $('#registerModal').modal('hide');
                    $('#loginModal').modal('show');
                    showAlert(result["message"], true);
                } else if (result["regOK"] === "NO") {
                    console.log("ERROR");
                    showAlert(result["message"], false);
                }
            }
            ,
            error: function (error) {
                console.log(error);
                showAlert("There seems to be something wrong wit the server. Try again later!", false);
            }
        });
    });
</script>

<!-- School Major selection javascript. Seungho 2017.11.01 -->
<script>
    $(document).ready(function () {
        $('#school-select').on('change', function () {
            var engMajors = ["Audio and Music Engineering", "Biomedical Engineering", "Chemical Engineering", "Computer Science", "Data Science", "Electrical and Computer Engineering", "Geomechanics", "Interdepartmental Engineering", "Engineering Science", "Mechanical Engineering", "Optical Engineering", "Optics", "Other"];
            var otherMajors = ["African and African American Studies", "American Sign Language", "American Studies", "Anthropology", "Applied Mathematics", "Archaeology, Technology and Historical Structures", "Art History", "Biological Sciences", "Biology", "Brain and Cognitive Sciences", "Business", "Chemistry", "Classics", "Comparative Literature", "Dance", "Data Science", "Digital Media Studies", "East Asian Studies", "Economics", "English", "Environmental Science", "Environmental Studies", "Epidemiology", "Film and Media Studies", "Financial Economics", "French", "Gender, Sexuality, and Women\'s Studies", "Geological Sciences", "Geomechanics", "German", "Health, Behavior, and Society", "Health Policy", "History", "Interdepartmental Studies", "International Relations", "Japanese", "Linguistics", "Mathematics", "Mathematics and Statistics", "Music", "Philosophy", "Physics", "Political Science", "Psychology", "Bioethics", "Environmental Health", "Religion", "Russian", "Russian Studies", "Spanish", "Statistics", "Studio Arts", "Other"];
            if (this.value == 'artsandscience') {
                $('#major').html('<option value="">Select Major</option>');
                var x;
                for (i = 0; i < otherMajors.length; i++) {
                    $('#major').append("<option>" + otherMajors[i] + "</option>");
                }
                $('#major').removeAttr('disabled');
            } else if (this.value == 'engineering') {
                $('#major').html('<option value="">Select Major</option>');
                var x;
                for (i = 0; i < engMajors.length; i++) {
                    $('#major').append("<option>" + engMajors[i] + "</option>");
                }
                $('#major').removeAttr('disabled');
            } else if (this.value == 'other') {
                $('#major').html('<option value="">Select Major</option>');
                $('#major').append("<option>Other</option>");
                $('#major').removeAttr('disabled');
            } else {
                $('#major').html('<option value="">Please select your school</option>');
                $('#major').attr('disabled', 'disabled');
            }
        })

    });
</script>

<script type="text/javascript" 

   src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlDn1p_hc7UfF1sfKEdHaz_0fnyJZIDk0&libraries=geometry,places">

</script>
<script src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/markerwithlabel/src/markerwithlabel.js"></script>


<script>
    var temp = {lat: 43.123050300, lng: -77.626940300};
    var map;
    var defaultIcon;
    var highlightedIcon;
    var largeInfowindow;
    var pos;
    var time;

    var buildings = [
                'Bausch & Lomb Hall(B&L)',
		'Morey Hall(MOREY)',
		'Eastman Theatre(ET)',
		'Strong Auditorium(STRNG)',
		'Hylan Building(HYLAN)',
		'Dewey Hall(DEWEY)',
		'The Margaret Warner Graduate School of Education and Human Development(LCHAS)',
		'Meliora Hall(MEL)',
		'Gavett Hall(GAVET)',
		'Goergen Hall(GEH)',
		'Rush Rhees Library(RRLIB)',
		'Lattimore Hall(LATT)',
		'Harkness Hall(HARK)',
		'Frederick Douglass Building(DOUG)',
		'Hoyt Hall(HOYT)',
		'Hutchison Hall(HUTCH)',
		'Carlson Library(CARLS)',
		'Todd Union Building(TODD)',
		'Goergen Athletic Center(GRGEN)',
		'SLATE',
		'Computer Studies Building(CSB)',
		'Wegmans Hall(WEGMN)',
		'University Health Service(UHS)',
		'Mount Hope Family Center(MHFC)',
		'Spurrier Hall(SPURR)',
		'Sage Art Center(SAGE)',
		'Rettner Hall(RETT)',
		'Wilmot Building(WILMT)',
		'Eastman School of Music(ESM)',
		'Interfaith Chaple(CHAPL)',
		'Hopeman Building(HOPE)',
		'School of Medicine and Dentistry(MED)',
		'SAUND',
		'Susan B. Anthony Hall',
		'Wilson Commons',
		'Gavett Hall',
		'Institute of Optics'

        ];
    var buildingID = [
                'B&L',
                'MOREY',
                'ET',
                'STRNG',
                'HYLAN',
                'DEWEY',
                'LCHAS',
                'MEL',
                'GAVET',
                'GEH',
                'RRLIB',
                'LATT',
                'HARK',
                'DOUG',
                'HOYT',
                'HUTCH',
                'CARLS',
                'TODD',
                'GRGEN',
                'SLATE',
                'CSB',
                'WEGMN',
                'UHS',
                'MHFC',
                'SPURR',
                'SAGE',
                'RETT',
                'WILMT',
                'ESM',
                'CHAPL',
                'HOPE',
                'MED',
                'SAUND',
                'Susan B. Anthony Hall',
                'Wilson Commons',
                'Gavett Hall',
                'Institute of Optics'

        ];

    var latitude = [
		43.127749,
		43.128396,
		43.157845,
		43.127786,
		43.125142,
		43.127362,
		43.128519,
		43.12777,
		43.126733,
		43.125649,
		43.128499,
		43.128068,
		43.127137,
		43.129105,
		43.127417,
		43.125274,
		43.124982,
		43.128212,
		43.130306,
		43.130276,
		43.125181,
		43.126076,
		43.129162,
		43.14659,
		43.130618,
		43.131061,
		43.128562,
		43.125701,
		43.157809,
		43.127008,
		43.126498,
		43.12305,
		43.120845,
		43.12988,
		43.128899,
		43.126733,
		43.125371

	];

    var longitude = [
		-77.629296,
		-77.629773,
		-77.60092,
		-77.631483,
		-77.630881,
		-77.630115,
 		-77.630969,
		-77.628131,
		-77.628978,
		-77.629345,
		-77.627798,
		-77.630629,
		-77.628324,
		-77.628826,
		-77.629563,
		-77.630811,
		-77.630181,
		-77.631826,
		-77.62977,
		-77.623611,
		-77.629812,
		-77.630099,
		-77.626879,
		-77.617508,
		-77.626936,
		-77.625616,
		-77.630075,
		-77.629185,
		-77.60103,
		-77.632425,
		-77.629999,
		-77.62694,
		-77.627167,
		-77.62666,
		-77.629737,
		-77.628978,
		-77.629282
	];

    var allLocations = [];
    var targetLocations = [];
    var address;
    console.log(buildings[1])

    function myMap() {

	// create invisiable label type
	var customMapTypeInvisible = new google.maps.StyledMapType([
	    {
		elementType: 'labels',
		stylers: [{visibility: 'off'}]
	    }
	    ], {
		name: 'invisible Style'
	    });
	var customMapTypeIdInvisible = 'invisible Style';

        var mapOptions = {
            center: new google.maps.LatLng(43.128499, -77.627798),
            zoom: 17,
	    mapTypeControlOptions:{
            mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain', 'myType']
	    }
        }

        map = new google.maps.Map(document.getElementById("map"), mapOptions);
        defaultIcon = makeMarkerIcon('0091ff');
        highlightedIcon = makeMarkerIcon('FFFF24');
        var geocoder = new google.maps.Geocoder();
        largeInfowindow = new google.maps.InfoWindow();

	//apply invisible style
	map.mapTypes.set('myType', customMapTypeInvisible);
	map.setMapTypeId('myType');

        document.getElementById('submit').addEventListener('click', function () {
        /*    if (marker) {
                marker.setMap(null);
            } */
            geocodeAddress(geocoder, map);


        });

        $(document).ready(function () {
            $('#building-search').submit(function (e) {
                e.preventDefault();
               /* if (marker) {
                    marker.setMap(null);
                } */
                geocodeAddress(geocoder, map);
                return false;
            });
        });
        // Try HTML5 geolocation.
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

            }, function () {
                showAlert("Sorry we are not allowed to get your location.", false);
            });
        } else {
            // Browser doesn't support Geolocation
            alert("Your browser does not support html5");
        }

        // add my location button and current location marker
        var myMarker = new google.maps.Marker({
		map: map,
		animation: google.maps.Animation.DROP,
		position: faisalabad
	});
	addYourLocationButton(map, myMarker);
	
	// apply all building markers
	loadAllLocations();

    }

    // load all loctions to marker

    function loadAllLocations(){ 
	for(i=0; i<buildings.length; i++){
	 //   var markerName = 'defaultMarker' + i;
	    var pos_temp = {lat: 43.123050300, lng: -77.626940300};
	    pos_temp.lat=latitude[i];
	    pos_temp.lng = longitude[i];
	    var markerDefault = new MarkerWithLabel({
        	position: pos_temp,
		map: map,
		draggable: false,
	 	raiseOnDrag: false,
		title: buildingID[i],
		labelContent: buildings[i],
		labelAnchor: new google.maps.Point(0, 0),
		labelClass: "labels", // the CSS class for the label
		labelInBackground: false,
		icon: pinSymbol('red')
             });

	     allLocations.push(markerDefault);
             markerDefault.addListener('mouseover', function() {
                this.setIcon(pinSymbol('yellow'));
             });

             markerDefault.addListener('mouseout', function() {
                this.setIcon(pinSymbol('red'));
             });

             markerDefault.addListener('click', function(){
		address = this.position;
                populateInfoWindow(this, largeInfowindow);
             });
					
	  }
    }

    // Set location symbol

	function pinSymbol(color) {
	  return {
	    path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z',
	    fillColor: color,
	    fillOpacity: 1,
	    strokeColor: '#000',
	    strokeWeight: 2,
	    scale: 2
	  };
	}

// Sets the map on all markers in the allLocations.
      function setMapOnAll(map) {
        for (var i = 0; i < allLocations.length; i++) {
          allLocations[i].setMap(map);
        }
      }

      // Removes the markers from the map, but keeps them in the array.
      function clearMarkers() {
        setMapOnAll(null);
      }

      // Remove the user markers from the map, but keep them in the array
      function clearUserMarkers(){
	showAllMarkers(null);
	}
      // Shows any markers currently in the array.
      function showMarkers() {
        setMapOnAll(map);
      }

// Sets the map on all markers in the targetLocations
      function showAllMarkers(map) {
        for (var i = 0; i < targetLocations.length; i++) {
          targetLocations[i].setMap(map);
        }
	console.log(targetLocations.length);
      }

      // Deletes all markers in the array by removing references to them.
      function deleteMarkers() {
        clearUserMarkers();
        targetLocations = [];
	showAllMarkers(map);
	console.log(targetLocations.length);
      }

    // load map
    google.maps.event.addDomListener(window, 'load', myMap);

    // create view my location icon

    var faisalabad = {lat:31.4181, lng:73.0776};				
    function addYourLocationButton(map, marker) 
    {
        var controlDiv = document.createElement('div');

        var firstChild = document.createElement('button');
    	firstChild.style.backgroundColor = '#fff';
    	firstChild.style.border = 'none';
    	firstChild.style.outline = 'none';
    	firstChild.style.width = '28px';
    	firstChild.style.height = '28px';
    	firstChild.style.borderRadius = '2px';
   	firstChild.style.boxShadow = '0 1px 4px rgba(0,0,0,0.3)';
    	firstChild.style.cursor = 'pointer';
    	firstChild.style.marginRight = '10px';
    	firstChild.style.padding = '0px';
    	firstChild.title = 'Your Location';
    	controlDiv.appendChild(firstChild);

    	var secondChild = document.createElement('div');
    	secondChild.style.margin = '5px';
    	secondChild.style.width = '18px';
    	secondChild.style.height = '18px';
    	secondChild.style.backgroundImage = 'url(https://maps.gstatic.com/tactile/mylocation/mylocation-sprite-1x.png)';
    	secondChild.style.backgroundSize = '180px 18px';
    	secondChild.style.backgroundPosition = '0px 0px';
    	secondChild.style.backgroundRepeat = 'no-repeat';
    	secondChild.id = 'you_location_img';
    	firstChild.appendChild(secondChild);

    	google.maps.event.addListener(map, 'dragend', function() {
        $('#you_location_img').css('background-position', '0px 0px');
    	});

    	firstChild.addEventListener('click', function() {
        	var imgX = '0';
        	var animationInterval = setInterval(function(){
            	if(imgX == '-18') imgX = '0';
            	else imgX = '-18';
            	$('#you_location_img').css('background-position', imgX+'px 0px');
        	}, 500);
            if(navigator.geolocation) {
            	navigator.geolocation.getCurrentPosition(function(position) {
                var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                marker.setPosition(latlng);
                map.setCenter(latlng);
                clearInterval(animationInterval);
                $('#you_location_img').css('background-position', '-144px 0px');
            });
            }	
            else{
            clearInterval(animationInterval);
            $('#you_location_img').css('background-position', '0px 0px');
            }
    	});

        controlDiv.index = 1;
    	map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(controlDiv);
    }

    function geocodeAddress(geocoder, resultsMap) {
        rawAddress = document.getElementById('address').value;
        address = document.getElementById('address').value + ' university of Rochester';
	console.log(address);
        geocoder.geocode({'address': address}, function (results, status) {
            if (status === google.maps.GeocoderStatus.OK) {
                resultsMap.setCenter(results[0].geometry.location);
                resultsMap.setZoom(18);
                temp.lat = results[0].geometry.location.lat();
                temp.lng = results[0].geometry.location.lng();
		
		var theBuildingID = document.getElementById('address').value;
		// this function is used to get buildingID of each building
		for(var i=0; i<buildings.length; i++){
		    if(rawAddress == buildings[i]){
			theBuildingID = buildingID[i];
			console.log(i, buildingID[i]);
			}
		}
		console.log("the building ID is");
		console.log(theBuildingID);


                var marker = new google.maps.Marker({
                    position: temp,
                    map: map,
                    animation: google.maps.Animation.DROP,
                    title: theBuildingID,
                    icon: defaultIcon
                    //	id: i
                });
                marker.addListener('mouseover', function () {
                    this.setIcon(highlightedIcon);
                });

                marker.addListener('mouseout', function () {
                    this.setIcon(defaultIcon);
                });

                marker.addListener('click', function () {
                    populateInfoWindow(this, largeInfowindow);
                });
		targetLocations.push(marker);
		map.setMapTypeId('roadmap');
		clearMarkers()
		showAllMarkers(map);

            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
        calculate_time([pos], [address], "WALKING");
    }

    function populateInfoWindow(marker, infowindow) {
        // Check to make sure the infowindow is not already opened on this marker.
	calculate_time([pos], [address], "WALKING");


	console.log(pos, address);
        if (infowindow.marker != marker) {
            // Clear the infowindow content to give the streetview time to load.
            infowindow.setContent('');
            infowindow.marker = marker;
            // Make sure the marker property is cleared if the infowindow is closed.
            infowindow.addListener('closeclick', function () {
                infowindow.marker = null;
            });
            var streetViewService = new google.maps.StreetViewService();
            var radius = 50;
            // In case the status is OK, which means the pano was found, compute the
            // position of the streetview image, then calculate the heading, then get a
            // panorama from that and set the options
            function getStreetView(data, status) {
                if (status == google.maps.StreetViewStatus.OK) {
                    var nearStreetViewLocation = data.location.latLng;

                    // this is used for create th info window on the map
                    var contentString = '<div class=\"card text-black bg-light\"> <div class=\"card-body\">'+
                    '<div>' +'<h1><strong>' + marker.title + '</strong></h1></div>'+'<div><blockquote class="blockquote"> we get it for you </div><div id="pano"></div></blockquote>' +
                        '<div> it takes ' + time + ' walk for you to get there</div>' +
                        '<div><input type=\"button\"  class=\"btn btn-secondary btn-sm\" value=\"View Route\" onclick =' +
                        '\"displayDirections(&quot;' + address + '&quot;);\"></input></div>' +
                        '<div> CSC 160 : web programming</div>' +
                        '<div><button type=\"button\" class=\"btn btn-info btn-sm\" id="MOREY" >view all Courses!</button></div>'
                        + '</div>'
                        + '</div>'
                    var heading = google.maps.geometry.spherical.computeHeading(
                        nearStreetViewLocation, marker.position);
                    infowindow.setContent(contentString);
                    var panoramaOptions = {
                        position: nearStreetViewLocation,
                        pov: {
                            heading: heading,
                            pitch: 30
                        }
                    };
                    var panorama = new google.maps.StreetViewPanorama(
                        document.getElementById('pano'), panoramaOptions);
                    //	alert('happan');

                    // Building information by JING SUN 2017.11.18
                    $(document).ready(function () {
                        $('#MOREY').on('click', function () {
                            infowindow.close();
                            var bd = marker.title;
			    console.log(marker.title);	
                            $.ajax({
                                url: '/bdInfo',
                                type: 'POST',
                                data: JSON.stringify({'name': bd}),
                                contentType: 'application/json;charset=UTF-8',
                                success: function (data) {
                                    $("#hidden_info").show();
                                    console.log("SUCCESS!");
                                    console.log(data);
                                    $("#bdg").text(data.value_1);
                                //    $("#crs").text(data.value_2);

                 				    var j=0;
                				    while(data.value_2[j]){
                                                	var row = $('<tr>');
                					for(var i=0; i<3; i++){
                					    row.append($('<td>').html(data.value_2[j][i]));
                					}
                					$('#crs').append(row);
                					j = j+1;
                				    }
                                    $("#close").click(function () {
                                        $("#hidden_info").hide();
                                        data = '';
                                        $("#bdg").text('');
                                        $('#crs').text('');
                                    });
                				},
                                error: function (error) {
                                    console.log(error);
                                }
                            });


                        });
                    });

                    function clickOther(e) {
                        thisObj = e.target ? e.target : event.srcElement;
                        if (thisObj.id == "hidden_info") return;
                        else {
                            $("#hidden_info").hide();
                        }
                    }

                    function close_info() {
                        document.getElementById('hidden_info').hide();
                    }

                    //END OF Building information by JING SUN 2017.11.18

                }
                else {
                    infowindow.setContent('<div>' + marker.title + '</div>' +
                        '<div>No Street View Found</div>');
                }
            }

            // Use streetview service to get the closest streetview image within
            // 50 meters of the markers position
            streetViewService.getPanoramaByLocation(marker.position, radius, getStreetView);
            // Open the infowindow on the correct marker.
            infowindow.open(map, marker);
        }
    }

    function makeMarkerIcon(markerColor) {
        var markerImage = new google.maps.MarkerImage(
            'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|' + markerColor +
            '|40|_|%E2%80%A2',
            new google.maps.Size(21, 34),
            new google.maps.Point(0, 0),
            new google.maps.Point(10, 34),
            new google.maps.Size(21, 34));
        return markerImage;

    }

    function calculate_time(origins, destination, travelMode) {
        var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix(
            {
                origins: origins,
                destinations: destination,
                travelMode: travelMode,
                unitSystem: google.maps.UnitSystem.IMPERIAL,
            }, function (response, status) {

                if (status !== google.maps.DistanceMatrixStatus.OK) {

                    window.alert('Error was: ' + status);

                } else {

                    show_result(response);

                }

            });
    }

    function show_result(response) {
        time = response.rows[0].elements[0].duration.text;
    }

    function displayDirections(destination) {

        var directionsService = new google.maps.DirectionsService;

        // Get mode again from the user entered value.

        var mode = 'WALKING';

        directionsService.route({

            // The origin is the passed in marker's position.

            origin: pos,

            // The destination is user entered address.

            destination: address,

            travelMode: google.maps.TravelMode[mode]

        }, function (response, status) {

            if (status === google.maps.DirectionsStatus.OK) {

                var directionsDisplay = new google.maps.DirectionsRenderer({

                    map: map,

                    directions: response,

                    draggable: true,

                    polylineOptions: {

                        strokeColor: 'green'

                    }

                });

            } else {

                window.alert('Directions request failed due to ' + status);

            }

        });

    }

</script>


{% endblock %}
